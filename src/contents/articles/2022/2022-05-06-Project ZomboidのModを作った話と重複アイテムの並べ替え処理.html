<script type="application/x-yaml">
title: "Project ZomboidのModを作った話と重複アイテムの並べ替え処理"
description: "「Reorder Duplicates by Condition」というProject ZomboidのModを作ったときの話。"
slug: about-project-zomboid-mod-reorder-duplicates-by-condition
published: 2022-05-06T16:42:02+09:00
updated: 2022-05-06T16:42:02+09:00
category: misc
</script>

<p>
  昨年後半あたりから「<a href="https://projectzomboid.com/">Project Zomboid</a>」というゲームをやっていました。ゲーム自体は2014年に購入して数百時間はプレイしていたのですが、ひさびさに再開したという感じです。
</p>
<p>
  それはいいのですが、アイテム収集癖のあるわたしはアイテムの管理に苦労していました。<br>
  このゲームのアイテムはカテゴリーや名前でソートできるのですが、同じ名前のアイテムはスタックされて、その中身はソートできません。<br>
  耐久値などのパラメーターが存在するアイテムの場合、同じ名前でも状態が異なるのです。<br>
  拾ったアイテムなどは最初から状態がバラバラなこともあって、雑に突っ込んでいるとアイテムを取り出すときに状態を確認して選び出すという行動を取らなくてはなりません。<br>
  それが面倒くさくて、重複アイテムを出し入れして並べ替えるというModを作ることにしました。
</p>
<p>
  アイテムを収納している箱やバッグから、一度プレイヤーキャラクターにアイテムを移し替える必要がある関係上、キャラクターが持っているアイテムは並べ替えられないなどの制限が発生してしまいましたが、どうにかModは完成し、2月27日に公開できました。<br>
  それから何度かアップデートして、3月12日版でひとまずやりたかったことは終わり、現在に至ります。
</p>
<p>
  <a href="https://steamcommunity.com/sharedfiles/filedetails/?id=2766834021">Steam Workshop::Reorder Duplicates by Condition</a>
</p>
<p>
  ありがたいことに2000人以上にも使っていただいており、作ってよかったと思っています。
</p>
<section>
  <h2>開発中の話</h2>
  <p>
    初めて<a href="https://www.lua.org/">Lua</a>を書きましたが、とりあえずエラーなく動いているので大丈夫だと思います……というか、基本的に<code>if</code>と<code>for</code>くらいしか使っていません。<br>
    どちらかというとゲームのAPIのほうが苦戦しました。<br>
    <a href="https://zomboid-javadoc.com/">APIの非公式Javadoc</a>はあるのですが、説明とかがあるわけではないので、それっぽいものを探して試すを繰り返しました。
  </p>
</section>
<section>
  <h2>並べ替え処理の話</h2>
  <p>
    たとえば「包丁」という武器カテゴリーアイテムが複数ある場合は次のような表示になります。
  </p>
  <pre>▶ 包丁 (5)</pre>
  <p>
    これをクリックするとスタックが展開されます。
  </p>
  <pre>▶ 包丁 (5)
包丁
包丁
包丁
包丁
包丁</pre>
  <p>
    その際に、耐久値などのバーが表示されますが、パラメーターによってはマウスオーバーでツールチップを表示させなければなりません。
  </p>
  <p>
    このゲームの重複アイテムスタックは任意のアイテムを取り出せますが、スタックに突っ込むときは最後にしか入れられません。<br>
    例えば上記の包丁の場合、3番めのアイテムを取り出すのは問題ありませんが、戻したときは5番目になります。
  </p>
  <p>
    Mod作成の場合、収納の中身を並べ替えてデータを書き換えるという処理も可能ですが、若干チート気味なので個人的には避けたく、バニラで可能な動作のみで完結させたかったのです。<br>
    チートっぽいと感じるのは、アイテムの取り出しや収納にはゲーム内時間が経過しますが、一気に書き換えるとノータイムで並べ替えが完了するからです。
  </p>
  <p>
    この最後にしか追加できないという状況で、最少の手順をどうやって考えればいいのかというのが課題でした。<br>
    一番最初に出したバージョンでは、たとえば耐久値が「低 → 高」の順で並べ替える際に、最低値以外はすべて並べ替えるという処理をしていました。目的は達成できますが、とても無駄が多かったです。
  </p>
  <p>
    ちなみにアイテムスタックの中身を並べ替える場合、キャラクターに次の動作を行わせます。<br>
    これはバニラの状態で手作業でやるものですが、これをModで自動化したいというわけです。
  </p>
  <ol>
    <li>スタックから任意のアイテムを取り出す（ゲーム内時間が経過）</li>
    <li>取り出したアイテムを元のスタックがある収納に入れる（ゲーム内時間が経過）</li>
  </ol>
  <p>
    これを耐久値などの、アイテムカテゴリーごとの重要パラメーターを見ながら行います。<br>
    アイテム数が10未満だと手作業でも大変ではないですが、そもそもアイテムの種類が多いのと、わたしのような収集癖があるプレイヤーは50個以上のスタックがあってもおかしくありません。<br>
    また、マルチプレイの場合は複数人分のアイテムスタックも存在するでしょう。<br>
    （Modの説明にはマルチプレイでテストしていないと書いていますが、サーバー機能は使っていないので普通に動くはずです）
  </p>
  <p>
    最少手順を考えなければ、先に書いたように最低または最高の状態以外のアイテムを全部並べ替えれば完了です。<br>
    しかし実際に使ってみると「このキャラクター手際が悪いな」と感じます。
  </p>
  <p>
    たとえば次のようなアイテムスタックがあるとします。<br>
    展開したアイテムに付いている角括弧内の数値は耐久値だと考えてください。
  </p>
  <pre>▶ 包丁 (5)
包丁 [1]
包丁 [3]
包丁 [10]
包丁 [10]
包丁 [5]</pre>
  <p>
    このとき、耐久値が低い順に並べ替えるなら、耐久値が<code>10</code>のアイテム2つを取り出して戻せばいいだけです。<br>
    ところが何も考えていない場合、耐久値が<code>1</code>以外のアイテムを<code>3</code> <code>5</code> <code>10</code> <code>10</code> の順で取り出して戻すことになります。<br>
    手際が悪いです。
  </p>
  <p>
    結局どうしたとかというと、並べ替えるアイテムを選択するためのデータを作成して、それで必要分を選び出すという処理をしました。
  </p>
  <p>
    まず、元の並びのアイテムスタックのデータを取り出し、次のように変換します。<br>
    （アイテムスタックのデータを取り出すのもちょっとややこしいのですがスキップします）。
  </p>
  <pre><code class="language-lua">{
  {
    condition = 耐久値,
    index = 元の並びのインデックス,
    item = {アイテムのデータテーブル}
  },
  ...
}</code></pre>
  <p>
    ここでは耐久値ですが、他にも色々なパラメーターを利用しています。それらの値はメソッドで取得するので、この時点で取得して適当なキーに値を入れておきます。<br>
    次は値ごとにアイテムをまとめます。
  </p>
  <pre><code class="language-lua">{
  [耐久値] = {
    value = 耐久値,
    last = 該当耐久値が一致する最後のアイテムのインデックス,
    items = {各アイテムのデータテーブル}
  },
  ...
}</code></pre>
  <p>
    ここまで終わったら、昇順または降順に応じて、上記のテーブルを耐久値で並べ替えます。これは<code>sort</code>を使うだけなので難しくありません。
  </p>
  <p>
    問題の並べ替えるべきアイテムのフィルタリングは次のようにしています。
  </p>
  <pre><code class="language-lua">local function createTransferItems(data, itemsCount)
    local transferItems = {}
    local previousLastIndex = 0
    for index, baseDataItems in ipairs(data) do
        for _, itemData in pairs(baseDataItems.items) do
            if itemData.index < previousLastIndex + 1 then
                if index > 1 then
                    table.insert(transferItems, itemData.item)
                end
            end
        end
        if #transferItems > 1 then
            previousLastIndex = itemsCount
        elseif previousLastIndex < baseDataItems.last then
            previousLastIndex = baseDataItems.last
        end
    end
    return transferItems
end</code></pre>
  <p>
    引数<code>data</code>には、前述の値ごとにまとめたアイテムのテーブルを渡します。<code>itemsCount</code>はそのままアイテム数です。<br>
    やっていることですが、たとえば低い順に並べ替える場合、現在の耐久値より低い耐久値のアイテムテーブルの最後のインデックスより前にある現在の耐久値のアイテムは並べ替えるべき、という感じです。
  </p>
  <p>
    あとはこのフィルタリングしたデータにそって取り出して戻すという処理をキューに追加するだけです。
  </p>
  <p>
    もしかするともっといい方法があるのかもしれませんが、わたしが思いついた方法は以上です。
  </p>
  <p>
    ModのソースはGitHubにあるので、興味のある方は見てみてください
  </p>
  <p>
    <a href="https://github.com/matori/pzmod-reorder-duplicates-by-condition">matori/pzmod-reorder-duplicates-by-condition</a>
  </p>
</section>
