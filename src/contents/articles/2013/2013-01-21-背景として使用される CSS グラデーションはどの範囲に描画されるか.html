<script type="application/x-yaml">
title: "背景として使用されるCSSグラデーションはどの範囲に描画されるか"
description: "背景として使われるCSSグラデーションが描画される範囲はどのように決定されるのか、仕様を読みながら考えてみたいと思います。"
slug: css-gradient-in-background
published: 2013-01-21T15:53:03+09:00
updated: 2013-01-21T15:53:03+09:00
category: webdev
</script>

<p>
  背景として使われるCSSグラデーションが描画される範囲はどのように決定されるのか、仕様を読みながら考えてみたいと思います。<br>
  参考にしたのは<a href="http://www.w3.org/TR/2012/CR-css3-images-20120417/">2012年4月17日版の「CSS Image Values and Replaced Content Module Level 3」</a>です。<a href="http://momdo.s35.xrea.com/web-html-test/spec/CR-css3-images-20120417.html">非公式の日本語訳</a>もあります。
</p>
<p>
  この記事に書いている範囲は自分で訳したので、上記の翻訳とは用語の表記などが異なっています。ご了承ください。<br>
  （調べ終わり頃に日本語訳があるのに気づいたので……）
</p>
<p>
  なお、ここ以降で単に「グラデーション」と書いている場合は「CSSグラデーション」のことを指します。
</p>
<section>
  <h2>グラデーションが描画される範囲について</h2>
  <p>
    まずはグラデーションが描画される範囲はどのように決定されるのかを調べてみます。<br>
    仕様を見ると次のように書かれています。
  </p>
  <blockquote cite="http://www.w3.org/TR/2012/CR-css3-images-20120417/#gradients">
    <p>
      グラデーションはグラデーションボックス（gradient box）と呼ばれる具体的なオブジェクトサイズ（concrete object size）の寸法内に描画される。しかし、グラデーション自体は本質的な寸法（intrinsic dimensions）を持っていない。
    </p>
    <p>
      グラデーションが背景に使用されるとき、初期状態でグラデーションが描画されるグラデーションボックスは要素のパディングボックスになる。もし<code>background-size</code>が<code>100px 200px</code>のように明示されているなら、グラデーションボックスは100pxの幅と200pxの高さになるだろう。<br>
      同様に、グラデーションが<code>list-style-image</code>に使用されるとき、グラデーションボックスはそのプロパティの初期オブジェクトサイズ（default object size）である1emの正方形になるだろう。
    </p>
  </blockquote>
  <p>
    さらっと書かれていますが、何言ってるか分かりません。<br>
    分かるのは背景に使われるときの初期範囲がパディングボックスであるということくらいです。<br>
    それだけでも十分といえば十分ですが、調べたいのは「どうやって決まるのか」なので、更に読んでみます。
  </p>
  <section>
    <h3>用語について</h3>
    <section>
      <h4>本質的な寸法（intrinsic dimensions）</h4>
      <blockquote cite="http://www.w3.org/TR/2012/CR-css3-images-20120417/#intrinsic-dimensions">
        <p>
          本質的な寸法とは、本質的な幅、本質的な高さ、そして本質的なアスペクト比（その比は幅と高さの比である）のことで、指定されたオブジェクトにそれぞれ存在するかもしれないし、しないかもしれない。<br>
          これらの本質的な寸法はオブジェクト自体の望ましい、または自然なサイズを表す。すなわち、それらはオブジェクトが使用されるコンテキストの機能ではない。CSSは本質的な寸法が一般的にどのように見つけられるかを定義しない。
        </p>
        <p>
          ラスター画像は3つの本質的な寸法（幅、高さ、アスペクト比）を持つオブジェクトの例である。<br>
          拡大縮小されるように作られたSVG画像は、おそらく本質的なアスペクト比だけを持つだろう。また、SVG画像は本質的な幅または高さのみを持つように作られることもある。<br>
          この仕様（CSS Image Values and Replaced Content Module Level 3）で定義されているCSSグラデーションは、そもそも本質的な寸法を持っていないオブジェクトの一例である。もう一方の例として、HTMLでの&lt;iframe&gt;要素のような埋め込みドキュメントがある。<br>
          オブジェクトは2つの本質的な寸法のみを持つことはできない。たとえば2つの寸法から自動的に3つ目を定義するといったもの。
        </p>
      </blockquote>
      <p>
        つまり……画像が最初から持っている幅と高さ、アスペクト比のことです。<br>
        たとえば800×600のjpg画像なら、その本質的な寸法は800pxの幅、600pxの高さ、4:3のアスペクト比、となります。<br>
        またSVG画像はそのうち1つしか持っていない場合もあります、と。<br>
        そしてグラデーションは、幅も高さもアスペクト比も持っていません。
      </p>
    </section>
    <section>
      <h4>指定サイズ（specified size)</h4>
      <blockquote cite="http://www.w3.org/TR/2012/CR-css3-images-20120417/#specified-size">
        <p>
          指定オブジェクトサイズとは、<code>width</code>や<code>height</code>または<code>background-size</code>プロパティなど、CSSから与えられるものである。<br>
          指定サイズは明確な幅と高さ、制約のセット、またはその組み合わせとなる。
        </p>
      </blockquote>
      <p>
        オブジェクトが持つ本質的な寸法ではなく、CSSで指定したサイズのこと。
      </p>
    </section>
    <section>
      <h4>具体的なオブジェクトサイズ（concrete object size)</h4>
      <blockquote cite="http://www.w3.org/TR/2012/CR-css3-images-20120417/#concrete-object-size">
        <p>
          具体的なオブジェクトサイズとは、オブジェクトを使用するコンテキストにおける初期オブジェクトサイズでのオブジェクトの本質的な寸法と指定サイズを組み合わせた結果であり、明確な幅と高さを持つ矩形を作り出す。
        </p>
      </blockquote>
      <p>
        ちょっと言い方がややこしいですが、オブジェクトにCSSを適用した後の、最終的なサイズということです。<br>
        初期オブジェクトサイズとは何か、というのは次に説明します。
      </p>
      <p>
        グラデーションボックスがこの具体的なオブジェクトサイズの寸法であることは最初に出てきました。<br>
        つまりこのサイズがグラデーションのサイズとなります。
      </p>
    </section>
    <section>
      <h4>初期オブジェクトサイズ（default object size)</h4>
      <blockquote cite="http://www.w3.org/TR/2012/CR-css3-images-20120417/#default-object-size">
        <p>
          初期オブジェクトサイズとは、本質的な寸法と指定サイズの両方が存在しないとき、具体的なオブジェクトサイズを決定するのに使用される明確な幅と高さを持つ矩形である。
        </p>
      </blockquote>
      <p>
        これは状況によって違うので具体的にどのサイズとは言えませんが、背景画像の初期オブジェクトサイズについては後ほど説明します。
      </p>
    </section>
  </section>
  <section>
    <h3>ここまでのまとめ</h3>
    <p>
      グラデーションはグラデーションボックスと呼ばれる範囲内に描画される。グラデーションボックスとは、具体的なオブジェクトサイズの寸法である。<br>
      しかし、グラデーションそれ自体は寸法を持っていないオブジェクトなので、具体的なオブジェクトサイズが存在しない。<br>
      グラデーションに具体的なオブジェクトサイズを与えるには、CSSの指定によって指定サイズを与える必要がある。<br>
      その指定サイズも存在しない場合、使用される状況に応じた初期オブジェクトサイズが用いられる。
    </p>
  </section>
  <p>
    では次に背景として用いられるグラデーションの描画範囲はどのように決定されるかを見ていきます。
  </p>
</section>
<section>
  <h2>背景として使用されるグラデーションのサイズはどのように決定されるか</h2>
  <p>
    これを知るには、まず具体的なオブジェクトサイズ（つまりグラデーションボックス）がどのように決定されるかを知る必要があります。<br>
    前セクションの用語解説では<q>オブジェクトを使用するコンテキストにおける初期オブジェクトサイズでのオブジェクトの本質的な寸法と指定サイズを組み合わせた結果</q>とだけ書かれていますが、より詳しく見ていきます。
  </p>
  <p>
    これは「<a href="http://www.w3.org/TR/2012/CR-css3-images-20120417/#default-sizing">CSS Image Values and Replaced Content Module Level 3 - 5.3.1. Default Sizing Algorithm</a>」に記載されています。
  </p>
  <blockquote cite="http://www.w3.org/TR/2012/CR-css3-images-20120417/#default-sizing">
    <p>このアルゴリズムは次のように定義される。</p>
    <ul>
      <li>指定サイズが明確な幅と高さである場合、具体的なオブジェクトサイズには幅と高さが付与される。</li>
      <li>指定サイズが幅または高さ（両方ではない）のみの場合、具体的なオブジェクトサイズには幅または高さが付与される。他の寸法は次のように決定される。
        <ol>
          <li>オブジェクトが本質的なアスペクト比を持つ場合、具体的なオブジェクトサイズの足りない寸法は本質的なアスペクト比と与えられた寸法を使用して計算される。</li>
          <li>そうでなければ、足りない寸法がオブジェクトの本質的な寸法により与えられる場合、足りない寸法はオブジェクトの本質的な寸法から取得される。</li>
          <li>そうでなければ、具体的なオブジェクトサイズの足りない寸法は初期オブジェクトサイズから取得される。</li>
        </ol>
      </li>
      <li>指定サイズが制約を持たない場合
        <ol>
          <li>オブジェクトが本質的な幅または高さを持つ場合、その本質的なサイズが指定サイズとして指定されているかのように解決される。</li>
          <li>そうでなければ、初期オブジェクトサイズに対するコンテイン制約（contain constraint）として解決される。</li>
        </ol>
      </li>
    </ul>
  </blockquote>
  <p>
    背景として使われるグラデーションに指定サイズを指定するには、<code>background-size</code>プロパティを使用します。<br>
    <code>background-size</code>に<code>50% 50%</code>のように、長さまたはパーセンテージの2つの値を指定した場合は1つ目のアルゴリズムが使用されます。<br>
    1つ目の値が幅、2つ目の値が高さとなり、ここで指定したサイズがグラデーションボックスとなります。<br>
   （パーセンテージがどう扱われるかは後述します)
  </p>
  <p>
    <code>background-size</code>に1つの長さもしくはパーセンテージのみを指定した場合、その値は幅として扱われ、未指定の高さの値にはプロパティの初期値である<code>auto</code>が指定されます。この<code>auto</code>は2つ目のアルゴリズムにより計算されます。<br>
    最初の値に<code>auto</code>を指定し、2つ目の値に長さもしくはパーセンテージを指定した場合も同様です。<br>
    グラデーションには本質的な寸法が存在しないので、2つ目のアルゴリズムのうち、3番目の項目が使用されます。一方にのみ指定された<code>auto</code>の値は初期オブジェクトサイズの幅または高さとなります。この値は<code>100%</code>として扱われると<a href="http://www.w3.org/TR/2012/CR-css3-background-20120724/#the-background-size">背景の仕様には書かれています</a>が、なぜそうなるのかは後述します。
  </p>
  <p>
    <code>background-size</code>が全くの未指定である場合、その値は初期値である<code>auto auto</code>となります。この場合、<code>background-size</code>は3つ目のアルゴリズムにより計算されます。<br>
    そして本質的な寸法を持たないグラデーションは3つ目のアルゴリズムのうち、2番目の項目に当たります。つまりコンテイン制約です。<br>
    <a href="http://www.w3.org/TR/2012/CR-css3-background-20120724/#the-background-size">背景の仕様</a>にも、寸法を持たないオブジェクトの<code>background-size: auto auto</code>は<code>contain</code>として扱われると書かれています。
  </p>
  <p>
    ここでまた新しい用語が出てきました。コンテイン制約とは何か、です。
  </p>
  <section>
    <h3>カバー並びにコンテイン制約サイジング</h3>
    <blockquote cite="http://www.w3.org/TR/2012/CR-css3-images-20120417/#cover-contain">
      <p>
        コンテイン制約とカバー制約の2つの共通指定サイズは、どちらもオブジェクトの本質的なアスペクト比を使用する指定された制約矩形に対して解決される。
      </p>
      <ul>
        <li>コンテイン制約とは、オブジェクトの本質的な寸法を持ち、加えて、それぞれ制約矩形の幅と高さよりも大きな幅も高さも持たない最大の矩形に具体的なオブジェクトサイズを設定することにより解決される。</li>
        <li>カバー制約とは、オブジェクトの本質的な寸法を持ち、加えて、それぞれ制約矩形の幅と高さよりも小さな幅も高さも持たない最小の矩形に具体的なオブジェクトサイズを設定することにより解決される。</li>
      </ul>
      <p>
        どちらの場合でも、オブジェクトが本質的なアスペクト比を持たない場合、具体的なオブジェクトサイズは指定された制約矩形である。
      </p>
    </blockquote>
    <p>
      <code>background-size</code>が指定されていない、背景として使用されるグラデーションはコンテイン制約であり、本質的なアスペクト比も持たないので、その具体的なオブジェクトサイズは背景として指定される箇所の初期オブジェクトサイズと等しくなる、ということです。
    </p>
    <p>
      ここでようやく前セクションのまとめで書いた「その指定サイズも存在しない場合、使用される状況に応じた初期オブジェクトサイズが用いられる」がどのように決定されているかが分かりました。
    </p>
    <p>
      よって、背景として使用される、指定サイズを持たないグラデーションボックスは、グラデーションを指定する<code>background-image</code>の初期オブジェクトサイズと同じサイズになります。
    </p>
    <p>
      次に<code>background-image</code>のオブジェクトサイズについてを見てみます。
    </p>
  </section>
  <section>
    <h3>background-imageのオブジェクトサイズ</h3>
    <p>
      <code>background-image</code>の初期オブジェクトサイズについては、仕様に載っている例で次のように書かれています。
    </p>
    <blockquote cite="http://www.w3.org/TR/2012/CR-css3-images-20120417/#object-sizing-examples">
      <p>
        <code>background-image</code>の初期オブジェクトサイズは、CSS 2.1とCSS Backgrounds and Borders Module Level 3により定義される。<br>
        CSS 2.1においては、指定サイズなしでデフォルトサイジングアルゴリズムを使用し、初期オブジェクトサイズとして背景配置領域を使用する。<br>
        CSS 3においては、<code>background-size</code>プロパティはデフォルトサイジングアルゴリズムまたはカバーもしくはコンテイン制約のどちらか一方のいずれかを呼び出すことでサイジング制約を付与できる。<code>background-repeat</code>の値が<code>round</code>である場合は、具体的なオブジェクトサイズは更に後の段階で調整される。
      </p>
    </blockquote>
    <p>
      ここで<code>background-image</code>の初期オブジェクトサイズは背景配置領域であることが分かりました。<br>
      前述したように「背景として使用される、指定サイズを持たないグラデーションボックスは、グラデーションを指定する<code>background-image</code>の初期オブジェクトサイズと同じサイズ」であるので、<code>background-size</code>による指定のない、背景として使用されるグラデーションの具体的なオブジェクトサイズは背景配置領域と等しい、ということになります。
    </p>
    <p>
      背景配置領域は<code>background-origin</code>プロパティによって指定が可能です。<br>
      そしてそのプロパティの初期値は<code>padding-box</code>であるので、<code>background-origin</code>による背景配置領域の指定のない箇所へ適用される、<code>background-size</code>による制約のないグラデーションの具体的なオブジェクトサイズは<code>padding-box</code>となります。
    </p>
    <p>
      これでやっと最初の方に出てきた「グラデーションが背景に使用されるとき、初期状態でグラデーションが描画されるグラデーションボックスは要素のパディングボックスになる」の意味が分かりました。
    </p>
    <p>
      <code>background-size</code>の2つの値のうち一方のみに指定された<code>auto</code>が<code>100%</code>として扱われる理由についてですが、デフォルトサイジングアルゴリズムにより、この値は初期オブジェクトサイズの幅または高さであります。<br>
      <code>background-size</code>による指定のないグラデーションの具体的なオブジェクトサイズは<code>background-image</code>の初期オブジェクトサイズであり、それは背景配置領域のサイズでもあります。<br>
      そして<code>background-size</code>のパーセンテージ値は背景配置領域に対するパーセンテージです（<a href="http://www.w3.org/TR/2012/CR-css3-background-20120724/#the-background-size">背景の仕様参照</a>）。<br>
      よって、デフォルトサイジングアルゴリズムの2つ目3番目が使用される、一方の値が<code>auto</code>の<code>background-size</code>が指定されたグラデーションの<code>auto</code>の寸法は背景配置領域の幅または高さと等しく、<code>100%</code>と等しくなります。
    </p>
  </section>
</section>
<section>
  <h2>まとめ</h2>
  <p>
    背景として使用されるグラデーションはどの範囲に描画されるか。
  </p>
  <ul>
    <li>
      <code>background-size</code>による指定がない限りは、背景配置領域に対して最大の大きさとなる。これは<code>background-size: auto auto</code>と同じであり、それは<code>contain</code>として扱われる。
    </li>
    <li>
      <code>background-size</code>へのパーセンテージは背景配置領域に対するパーセンテージである。
    </li>
    <li>
      <code>background-size</code>の値の一方にのみ<code>auto</code>が指定されたグラデーションは、長さもしくはパーセンテージの幅または高さは指定したサイズ、<code>auto</code>が指定された幅または高さは背景配置領域に対して最大のサイズとなる。
    </li>
    <li>
      <code>background-size</code>の2つの値に長さまたはパーセンテージを指定した場合は、その指定したサイズとなる。
    </li>
    <li>
      背景配置領域は<code>background-origin</code>プロパティで領域を指定可能である。
    </li>
  </ul>
  <p>
    以上で終わりですが、読み違えている可能性もありますので、気になる方は自分でも調べてみることをお勧めします。<br>
    背景以外の初期オブジェクトサイズは仕様に書かれていますので、興味のある方はご確認ください。
  </p>
</section>
<section>
  <h2>おまけ</h2>
  <p>
    たまに「グラデーションが<code>background-repeat: repeat</code>で繰り返し表示できない」と書いている方を見かけますが、それは<code>background-size</code>で明確なサイズを指定していないからです。<br>
    それと単純なグラデーションの繰り返しなら<code>repeating-[linear/radial]-gradient()</code>があるので、それを使うのもいいと思います。
  </p>
  <p>
    あと、背景に使うグラデーションを指定するのは<code>background-image</code>プロパティです。<code>background-color</code>ではありません。
  </p>
  <p>
    まだ実装はありませんが、グラデーションは<code>list-style-image</code>や<code>content</code>プロパティなどにも指定できることになっています。<br>
    一応、もうすぐ<a href="http://trac.webkit.org/changeset/139836">Webkitで使えるようになります</a>。<code>-webkit-</code>接頭辞も外れます。
  </p>
</section>
